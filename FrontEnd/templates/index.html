<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>动态 Polygon.io 实时订阅</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div id="content">
      <div id="subscription-area">
        <h2>当前订阅</h2>
        <form id="addForm" onsubmit="return false;">
          <label>
            事件类型：
            <select id="eventType">
              <option value="AM">Agg Minute（分钟聚合）</option>
            </select>
          </label>
          <label>
            股票代码：
            <input id="symbol" placeholder="例如 AAPL" />
          </label>
          <button id="addBtn">添加订阅</button>
        </form>

        <h2>订阅列表</h2>
        <ul id="subList"></ul>
      </div>

      <div id="data-area">
        <h1>Polygon.io 实时数据</h1>
        <div id="output"></div>
      </div>
    </div>
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    <script>
      const socket = io();
      socket.on('connect', () => {
        socket.emit('client_version', { version: io.version });
        rehydrateFromServer();
      });

      const subs = new Set();
      const subListEl = document.getElementById('subList');
      const outputEl = document.getElementById('output');

      // 从后端 REST 接口取订阅快照并渲染
      async function rehydrateFromServer() {
        try {
          const res = await fetch('/api/subs', { cache: 'no-store' });
          const data = await res.json();
          const serverSubs = Array.isArray(data.subs) ? data.subs : [];
          subs.clear();
          serverSubs.forEach((s) => subs.add(s));
          renderSubs();
        } catch (e) {
          console.error('rehydrate failed:', e);
        }
      }

      // 渲染订阅列表
      function renderSubs() {
        subListEl.innerHTML = '';
        const ordered = [...subs].sort((a, b) => {
          const [ta, sa] = a.split('.', 2);
          const [tb, sb] = b.split('.', 2);
          if (ta !== tb) return ta.localeCompare(tb, 'en', { sensitivity: 'base' });
          return (sa || '').localeCompare(tb ? sb : '', 'en', { numeric: true, sensitivity: 'base' });
        });
        for (const s of ordered) {
          const li = document.createElement('li');
          li.textContent = s;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = '✖';
          btn.onclick = () => removeSub(s);
          li.appendChild(btn);
          subListEl.appendChild(li);
        }
      }
      

      // 添加订阅
      document.getElementById('addBtn').addEventListener('click', () => {
        const type = document.getElementById('eventType').value;
        const sym = document.getElementById('symbol').value.trim().toUpperCase();
        if (!sym) return alert('请先输入股票代码');
        const sub = `${type}.${sym}`;
        if (subs.has(sub)) return alert('已存在该订阅');
        subs.add(sub);
        renderSubs();
        socket.emit('subscribe_one', { subscriptions: [sub] });
        document.getElementById('symbol').value = '';
      });

      // 移除订阅
      function removeSub(sub) {
        subs.delete(sub);
        renderSubs();
        socket.emit('unsubscribe_one', { subscriptions: [sub] });
      }

      // 后端消息处理
      socket.on('subscribed', (msg) => {
        appendLine(`✔ 已订阅：${msg.subscriptions.join(', ')}`);
      });
      socket.on('unsubscribed', (msg) => {
        appendLine(`✖ 已取消：${msg.subscriptions.join(', ')}`);
      });

      socket.on('polygon_data', (data) => {
        // 格式化数字
        const replacer = (k, v) =>
          typeof v === 'number' && !Number.isInteger(v) ? Number(v.toFixed(6)) : v;
        const json = JSON.stringify(data, replacer, 2);

        const details = document.createElement('details');
        details.open = false;
        details.style.borderBottom = '1px solid #eee';

        const summary = document.createElement('summary');
        const previewTime =
          data.t_et ||
          (data.t
            ? new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
              }).format(new Date(data.t))
            : '');
        summary.textContent = `${data.ev ?? ''}  ${data.sym ?? ''}  ${previewTime}`;
        summary.style.cursor = 'pointer';
        summary.style.padding = '2px 4px';
        details.appendChild(summary);

        const pre = document.createElement('pre');
        pre.textContent = json;
        pre.style.margin = '4px 8px';
        details.appendChild(pre);

        outputEl.appendChild(details);
        trimOutput(500);
        scrollOutput();
      });

      function appendLine(text) {
        const div = document.createElement('div');
        div.className = 'log';
        div.textContent = text;
        outputEl.appendChild(div);
        scrollOutput();
      }

      function scrollOutput() {
        const nearBottom = outputEl.scrollTop + outputEl.clientHeight >= outputEl.scrollHeight - 10;
        if (nearBottom) outputEl.scrollTop = outputEl.scrollHeight;
      }

      function trimOutput(max) {
        while (outputEl.childElementCount > max) {
          outputEl.removeChild(outputEl.firstElementChild);
        }
      }
    </script>
  </body>
</html>
