<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>动态 Polygon.io 实时订阅</title>
  </head>
  <body>
    <h1>Polygon.io 实时数据</h1>

    <!-- 用户输入区 -->
    <div>
      <label>
        事件类型：
        <select id="eventType">
          <option value="AM">Agg Minute（分钟聚合）</option>
        </select>
      </label>

      <label>
        股票代码：
        <input id="symbol" placeholder="例如 AAPL" />
      </label>

      <button id="sub">Subscribe</button>
      <button id="unsub">Unsubscribe</button>
    </div>

    <!-- 用来显示收到的数据 -->
    <div
      id="output"
      style="
        height: 300px;
        overflow: auto;
        border: 1px solid #ccc;
        font-family: ui-monospace, monospace;
      "
    ></div>
    <!-- 引入 Socket.IO 客户端脚本 -->
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>

    <script>
      // 连接到后端 Flask-SocketIO
      const socket = io();
      socket.on('connect', () => {
        // 上报客户端版本给服务端
        socket.emit('client_version', { version: io.version });
      });

      const out = document.getElementById('output');

      // 点击 Subscribe 时，把用户选择的订阅列表发给后端
      document.getElementById('sub').addEventListener('click', () => {
        const type = document.getElementById('eventType').value;
        const sym = document.getElementById('symbol').value.trim().toUpperCase();
        if (!sym) return alert('请先输入股票代码');
        // 构造订阅字符串，如 "T.AAPL"
        const subs = [`${type}.${sym}`];
        socket.emit('subscribe', { subscriptions: subs });
      });

      // 点击 Unsubscribe 时，通知后端断开
      document.getElementById('unsub').addEventListener('click', () => {
        socket.emit('unsubscribe');
      });

      // 后端确认订阅成功后会发回 'subscribed' 事件
      socket.on('subscribed', (msg) => {
        out.textContent += `✔ 已订阅：${msg.subscriptions.join(', ')}\n`;
      });

      // 后端确认取消订阅后会发回 'unsubscribed'
      socket.on('unsubscribed', (msg) => {
        const list = msg.subscriptions.join(', ');
        out.textContent += `✖ 已取消订阅：${list}\n`;
        out.scrollTop = out.scrollHeight;
      });

      socket.on('polygon_data', (data) => {
        // 可选：小数保留到 6 位
        const replacer = (k, v) =>
          typeof v === 'number' && !Number.isInteger(v) ? Number(v.toFixed(6)) : v;

        const json = JSON.stringify(data, replacer, 2);

        // === 核心改动：生成 <details><summary>preview</summary><pre>JSON</pre></details> ===
        const details = document.createElement('details'); // 默认折叠
        details.style.borderBottom = '1px solid #eee';

        const summary = document.createElement('summary');
        const previewTime =
          data.t_et ||
          (data.t
            ? new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
              }).format(new Date(data.t))
            : '');
        summary.textContent = `${data.ev ?? ''}  ${data.sym ?? ''}  ${previewTime}`;
        summary.style.cursor = 'pointer';
        summary.style.padding = '2px 4px';
        details.appendChild(summary);

        const pre = document.createElement('pre');
        pre.textContent = json;
        pre.style.margin = '4px 8px';
        details.appendChild(pre);

        out.appendChild(details);
        // === 以上为折叠显示 ===

        // 自动滚动（仅当接近底部）
        const nearBottom = out.scrollTop + out.clientHeight >= out.scrollHeight - 10;
        if (nearBottom) out.scrollTop = out.scrollHeight;

        // 简单限流：最多保留最近 N 条
        const MAX_ITEMS = 500;
        while (out.childElementCount > MAX_ITEMS) {
          out.removeChild(out.firstElementChild);
        }
      });
    </script>
  </body>
</html>
