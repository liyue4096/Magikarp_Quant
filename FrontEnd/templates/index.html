<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>动态 Polygon.io 实时订阅</title>
  </head>
  <body>
    <h1>Polygon.io 实时数据</h1>

    <!-- 用户输入区 -->
    <div>
      <label>
        事件类型：
        <select id="eventType">
          <option value="AM">Agg Minute（分钟聚合）</option>
        </select>
      </label>

      <label>
        股票代码：
        <input id="symbol" placeholder="例如 AAPL" />
      </label>

      <button id="sub">Subscribe</button>
      <button id="unsub">Unsubscribe</button>
    </div>

    <!-- 用来显示收到的数据 -->
    <pre id="output" style="height: 300px; overflow: auto; border: 1px solid #ccc"></pre>

    <!-- 引入 Socket.IO 客户端脚本 -->
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>

    <script>
      // 连接到后端 Flask-SocketIO
      const socket = io();
      socket.on('connect', () => {
        // 上报客户端版本给服务端
        socket.emit('client_version', { version: io.version });
      });

      const out = document.getElementById('output');

      // 点击 Subscribe 时，把用户选择的订阅列表发给后端
      document.getElementById('sub').addEventListener('click', () => {
        const type = document.getElementById('eventType').value;
        const sym = document.getElementById('symbol').value.trim().toUpperCase();
        if (!sym) return alert('请先输入股票代码');
        // 构造订阅字符串，如 "T.AAPL"
        const subs = [`${type}.${sym}`];
        socket.emit('subscribe', { subscriptions: subs });
      });

      // 点击 Unsubscribe 时，通知后端断开
      document.getElementById('unsub').addEventListener('click', () => {
        socket.emit('unsubscribe');
      });

      // 后端确认订阅成功后会发回 'subscribed' 事件
      socket.on('subscribed', (msg) => {
        out.textContent += `✔ 已订阅：${msg.subscriptions.join(', ')}\n`;
      });

      // 后端确认取消订阅后会发回 'unsubscribed'
      socket.on('unsubscribed', (msg) => {
        const list = msg.subscriptions.join(', ');
        out.textContent += `✖ 已取消订阅：${list}\n`;
        out.scrollTop = out.scrollHeight;
      });

      // 实时报价由后端用 socketio.emit('polygon_data', data) 广播
      socket.on('polygon_data', (data) => {
        const time = new Date(data.t).toLocaleTimeString();
        if (data.ev === 'AM') {
          // 分钟聚合，用 c（本分钟收盘价）
          line = `[${time}] ${data.sym}/AM 收盘价 → ${data.c}`;
        }
        out.textContent += line + '\n';
        out.scrollTop = out.scrollHeight;
      });
    </script>
  </body>
</html>
